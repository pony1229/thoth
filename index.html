<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰˜ç‰¹å¡”ç¾…æŠ½ç‰Œå™¨ - ç‰Œé™£ç‰ˆ</title>
  <meta name="description" content="ä½¿ç”¨æ‰˜ç‰¹å¡”ç¾…ç‰Œé€²è¡Œå„ç¨®ç‰Œé™£ï¼šæ™‚é–“ä¹‹æµã€è–ä¸‰è§’ã€ç›´æŒ‡æ ¸å¿ƒã€äºŒé¸ä¸€ï¼å¤šé¸ä¸€ã€è–åå­—ã€‚ç®¡ç†ç´€éŒ„ã€åˆ†äº«çµæœã€åˆ‡æ›ä¸»é¡Œèˆ‡å¸¸ç”¨å•é¡Œã€‚">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 40px;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(to bottom, #1e2a3a, #2c3e50);
      color: #e0e6ed;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: linear-gradient(to bottom, #e3eaf2, #f5f9fc);
      color: #232f45;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #a4c3f0;
    }
    body.light-mode h1 {
      color: #4a6fa5;
    }
    input[type="text"] {
      margin-top: 10px;
      padding: 10px;
      width: 280px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: #304258;
      color: #fff;
      outline: none;
    }
    body.light-mode input[type="text"] {
      background: #dde6f0;
      color: #232f45;
    }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      font-size: 0.95rem;
      border: none;
      border-radius: 6px;
      background-color: #4a6fa5;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #6c91cc;
    }
    body.light-mode button {
      background-color: #6b8bbd;
    }
    body.light-mode button:hover {
      background-color: #8eaadd;
    }
    .small-btn {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 0.8rem;
      background-color: #3d5679;
      border-radius: 4px;
    }
    body.light-mode .small-btn {
      background-color: #9caecc;
      color: #232f45;
    }
    #result {
      margin-top: 20px;
      font-size: 1rem;
      text-align: center;
      white-space: pre-line;
      background: #273649;
      padding: 15px;
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      color: #e0e6ed;
    }
    body.light-mode #result {
      background: #ffffff;
      color: #232f45;
    }
    #images {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    #images img {
      width: 150px;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    @media (max-width: 768px) {
      #images img {
        width: 45%;
      }
    }
    @media (max-width: 480px) {
      #images img {
        width: 90%;
      }
    }
    #history {
      margin-top: 30px;
      width: 90%;
      max-width: 600px;
      font-size: 0.9rem;
    }
    #history h3 {
      color: #a4c3f0;
      margin-bottom: 10px;
    }
    body.light-mode #history h3 {
      color: #4a6fa5;
    }
    .history-entry {
      background: #1f2b3a;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    body.light-mode .history-entry {
      background: #e8eff7;
    }
    .history-entry pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }
    .history-entry-buttons {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    /* Layout for controls and prompts */
    #controls, #prompts, #spread-select, #spreadDesc {
      width: 90%;
      max-width: 700px;
      margin-top: 20px;
    }
    #spread-select {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #spreadDesc {
      font-size: 0.9rem;
      white-space: pre-line;
    }
    #prompts h3 {
      margin-bottom: 10px;
      color: #a4c3f0;
    }
    body.light-mode #prompts h3 {
      color: #4a6fa5;
    }
    #promptList {
      list-style-type: none;
      padding: 0;
      margin-bottom: 10px;
    }
    #promptList li {
      margin-bottom: 6px;
    }
    #promptList li span {
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>ğŸƒ æ‰˜ç‰¹å¡”ç¾…æŠ½ç‰Œå™¨</h1>
  <!-- å•é¡Œè¼¸å…¥æ¡† -->
  <input type="text" id="question" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ (å¯ç•™ç©º)" aria-label="è¼¸å…¥å•é¡Œ">
  <!-- ç‰Œé™£é¸æ“‡èˆ‡æŠ½ç‰ŒæŒ‰éˆ• -->
  <div id="spread-select">
    <label for="spread">é¸æ“‡ç‰Œé™£ï¼š</label>
    <select id="spread" onchange="updateSpreadDescription()">
      <option value="flow" selected>ä¸‰å¼µç‰Œ â€” æ™‚é–“ä¹‹æµ</option>
      <option value="trinity">ä¸‰å¼µç‰Œ â€” è–ä¸‰è§’</option>
      <option value="core">å››å¼µç‰Œ â€” ç›´æŒ‡æ ¸å¿ƒ</option>
      <option value="decision">äº”å¼µç‰Œ â€” äºŒé¸ä¸€ï¼å¤šé¸ä¸€</option>
      <option value="celtic">åå¼µç‰Œ â€” è–åå­—</option>
    </select>
    <button aria-label="æŠ½ç‰Œ" onclick="drawSpread()">æŠ½ç‰Œ</button>
    <button aria-label="è¤‡è£½çµæœ" onclick="copyResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
  </div>
  <!-- ç‰Œé™£èªªæ˜ -->
  <div id="spreadDesc"></div>
  <!-- çµæœé¡¯ç¤ºå€ -->
  <div id="result" aria-live="polite"></div>
  <div id="images"></div>
  <!-- æŠ½ç‰Œç´€éŒ„å€ -->
  <div id="history">
    <h3>ğŸ“œ æŠ½ç‰Œç´€éŒ„ï¼š</h3>
  </div>
  <!-- å…¶ä»–æ§åˆ¶ï¼šä¸»é¡Œèˆ‡åˆ†äº« -->
  <div id="controls">
    <button aria-label="åˆ‡æ›ä¸»é¡Œ" onclick="toggleTheme()">ğŸ¨ åˆ‡æ›ä¸»é¡Œ</button>
    <button aria-label="åˆ†äº«çµæœåœ–ç‰‡" onclick="shareAsImage()">ğŸ–¼ï¸ åˆ†äº«çµæœåœ–ç‰‡</button>
  </div>
  <!-- å¸¸ç”¨å•é¡Œç®¡ç† -->
  <div id="prompts">
    <h3>ğŸ”– å¸¸ç”¨å•é¡Œï¼š</h3>
    <ul id="promptList"></ul>
    <input type="text" id="newPrompt" placeholder="è¼¸å…¥å¸¸ç”¨å•é¡Œ..." aria-label="è¼¸å…¥å¸¸ç”¨å•é¡Œ">
    <button class="small-btn" aria-label="å„²å­˜å¸¸ç”¨å•é¡Œ" onclick="savePrompt()">ï¼‹ å„²å­˜å•é¡Œ</button>
  </div>

  <script>
    // Tarot card list (Thoth deck, no reversals needed)
    const cards = [
      "0 æ„šäºº", "I é­”æ³•å¸«", "II å¥³ç¥­å¸", "III çš‡å", "IV çš‡å¸", "V å¤§ç¥­å¸",
      "VI æˆ€äºº", "VII æˆ°è»Š", "VIII èª¿ç¯€", "IX éš±è€…", "X å‘½é‹ä¹‹è¼ª",
      "XI æ…¾æœ›", "XII åŠäºº", "XIII æ­»ç¥", "XIV è—è¡“", "XV æƒ¡é­”", "XVI å¡”",
      "XVII æ˜Ÿæ˜Ÿ", "XVIII æœˆäº®", "XIX å¤ªé™½", "XX æ–°ç´€å…ƒ", "XXI å®‡å®™",
      "æ¬Šæ–ç‹ç‰Œ", "æ¬Šæ–äºŒï¼ˆçµ±æ²»ï¼‰", "æ¬Šæ–ä¸‰ï¼ˆç¾å¾·ï¼‰", "æ¬Šæ–å››ï¼ˆå®Œæˆï¼‰", "æ¬Šæ–äº”ï¼ˆçˆ­é¬¥ï¼‰",
      "æ¬Šæ–å…­ï¼ˆå‹åˆ©ï¼‰", "æ¬Šæ–ä¸ƒï¼ˆå‹‡æ°£ï¼‰", "æ¬Šæ–å…«ï¼ˆè¿…é€Ÿï¼‰", "æ¬Šæ–ä¹ï¼ˆåŠ›é‡ï¼‰", "æ¬Šæ–åï¼ˆå£“åŠ›ï¼‰",
      "æ¬Šæ–ç‹å­", "æ¬Šæ–å…¬ä¸»", "æ¬Šæ–å¥³ç‹", "æ¬Šæ–é¨å£«",
      "è–æ¯ç‹ç‰Œ", "è–æ¯äºŒï¼ˆæ„›ï¼‰", "è–æ¯ä¸‰ï¼ˆè±ç››ï¼‰", "è–æ¯å››ï¼ˆæ··äº‚ï¼‰", "è–æ¯äº”ï¼ˆå¤±æœ›ï¼‰",
      "è–æ¯å…­ï¼ˆæ„‰æ‚…ï¼‰", "è–æ¯ä¸ƒï¼ˆå¹»è±¡ï¼‰", "è–æ¯å…«ï¼ˆæ€ æƒ°ï¼‰", "è–æ¯ä¹ï¼ˆå¹¸ç¦ï¼‰", "è–æ¯åï¼ˆé£½å’Œï¼‰",
      "è–æ¯ç‹å­", "è–æ¯å…¬ä¸»", "è–æ¯å¥³ç‹", "è–æ¯é¨å£«",
      "å¯¶åŠç‹ç‰Œ", "å¯¶åŠäºŒï¼ˆå¹³è¡¡ï¼‰", "å¯¶åŠä¸‰ï¼ˆæ‚²å‚·ï¼‰", "å¯¶åŠå››ï¼ˆä¼‘æˆ°ï¼‰", "å¯¶åŠäº”ï¼ˆæ“Šæ½°ï¼‰",
      "å¯¶åŠå…­ï¼ˆç§‘å­¸ï¼‰", "å¯¶åŠä¸ƒï¼ˆè©­è¨ˆï¼‰", "å¯¶åŠå…«ï¼ˆå¹²æ¶‰ï¼‰", "å¯¶åŠä¹ï¼ˆæ®˜é…·ï¼‰", "å¯¶åŠåï¼ˆæ¯€æ»…ï¼‰",
      "å¯¶åŠç‹å­", "å¯¶åŠå…¬ä¸»", "å¯¶åŠå¥³ç‹", "å¯¶åŠé¨å£«",
      "åœ“ç›¤ç‹ç‰Œ", "åœ“ç›¤äºŒï¼ˆè®ŠåŒ–ï¼‰", "åœ“ç›¤ä¸‰ï¼ˆå·¥ä½œï¼‰", "åœ“ç›¤å››ï¼ˆæ¬ŠåŠ›ï¼‰", "åœ“ç›¤äº”ï¼ˆæ†‚æ…®ï¼‰",
      "åœ“ç›¤å…­ï¼ˆæˆåŠŸï¼‰", "åœ“ç›¤ä¸ƒï¼ˆå¤±æ•—ï¼‰", "åœ“ç›¤å…«ï¼ˆè¬¹æ…ï¼‰", "åœ“ç›¤ä¹ï¼ˆæ”¶ç©«ï¼‰", "åœ“ç›¤åï¼ˆè²¡å¯Œï¼‰",
      "åœ“ç›¤ç‹å­", "åœ“ç›¤å…¬ä¸»", "åœ“ç›¤å¥³ç‹", "åœ“ç›¤é¨å£«"
    ];

    // Spread definitions
    const spreads = {
      flow: {
        name: "ä¸‰å¼µç‰Œ â€” æ™‚é–“ä¹‹æµ",
        count: 3,
        labels: ["éå»ï¼åŸå› ï¼èº«", "ç¾åœ¨ï¼å¿ƒï¼ç›®å‰çµæœ", "æœªä¾†ï¼å»ºè¨€ï¼éˆ"],
        description: "é€éæ™‚é–“çš„æµå‹•ä¾†åˆ†æå•é¡Œï¼Œç¬¬ä¸€å¼µä»£è¡¨éå»èˆ‡åŸå› ï¼Œç¬¬äºŒå¼µä»£è¡¨ç¾åœ¨çš„æƒ…æ„Ÿèˆ‡çµæœï¼Œç¬¬ä¸‰å¼µæŒ‡å‘æœªä¾†çš„å»ºè­°èˆ‡éˆæ€§æŒ‡å¼•ã€‚"
      },
      trinity: {
        name: "ä¸‰å¼µç‰Œ â€” è–ä¸‰è§’",
        count: 3,
        labels: ["æˆ‘ä»¥ç‚ºçš„ç‹€æ³", "çœŸå¯¦çš„ç‹€æ³", "å»ºè¨€"],
        description: "å°ç…§è‡ªæˆ‘æ„Ÿå—èˆ‡ç¾å¯¦ç‹€æ…‹ï¼Œç¬¬ä¸‰å¼µæä¾›å°æ‡‰çš„å»ºè¨€ã€‚"
      },
      core: {
        name: "å››å¼µç‰Œ â€” ç›´æŒ‡æ ¸å¿ƒ",
        count: 4,
        labels: ["å•é¡Œæ ¸å¿ƒ", "éšœç¤™", "å°ç­–", "è³‡æºï¼é•·è™•"],
        description: "èšç„¦å•é¡Œæ ¸å¿ƒï¼Œè©•ä¼°éšœç¤™èˆ‡è³‡æºï¼Œä¸¦æä¾›å°ç­–ã€‚"
      },
      decision: {
        name: "äº”å¼µç‰Œ â€” äºŒé¸ä¸€ï¼å¤šé¸ä¸€",
        count: 5,
        labels: ["é¸é …Açš„ç‹€æ…‹", "é¸é …Bçš„ç‹€æ…‹", "é¸é …Aå¯èƒ½çš„çµæœ", "é¸é …Bå¯èƒ½çš„çµæœ", "ç•¶äº‹äººçš„ç‹€æ…‹"],
        description: "æ¯”è¼ƒå…©å€‹é¸é …çš„ç¾æ³èˆ‡å¯èƒ½çµæœï¼Œä¸¦æª¢è¦–ç•¶äº‹äººçš„ç‹€æ…‹ã€‚"
      },
      celtic: {
        name: "åå¼µç‰Œ â€” è–åå­—",
        count: 10,
        labels: ["ç¾æ³", "æŒ‘æˆ°", "æ½›åœ¨åŸå› ", "éå»", "å¯èƒ½çš„æœªä¾†", "è¿‘æœŸçš„æœªä¾†", "è‡ªèº«æ…‹åº¦", "ç’°å¢ƒï¼å‘¨åœçœ‹æ³•", "å¸Œæœ›ï¼ææ‡¼", "æœ€çµ‚çµæœ"],
        description: "ç¶“å…¸çš„åå­—ç‰Œé™£ï¼Œç”¨æ–¼å…¨é¢æª¢è¦–ç¾æ³ã€æŒ‘æˆ°ã€æ·±å±¤åŸå› ã€éå»ã€æœªä¾†è¶¨å‹¢ã€è‡ªèº«èˆ‡ç’°å¢ƒçš„æ…‹åº¦ä»¥åŠæœ€çµ‚çµæœã€‚"
      }
    };

    let lastResult = "";
    let lastSelectedCards = [];
    const resultDiv = document.getElementById("result");
    const imagesDiv = document.getElementById("images");
    const historyDiv = document.getElementById("history");
    let savedPrompts = [];

    // Shuffle function
    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Update spread description
    function updateSpreadDescription() {
      const value = document.getElementById('spread').value;
      const spread = spreads[value];
      const desc = `${spread.description}\n\nç‰Œä½èªªæ˜ï¼š\n` +
        spread.labels.map((label, idx) => `${idx + 1}. ${label}`).join('\n');
      document.getElementById('spreadDesc').innerText = desc;
    }

    // Draw the selected spread
    function drawSpread() {
      const selection = document.getElementById('spread').value;
      const spread = spreads[selection];
      drawCards(spread.count, spread.labels, spread.name);
    }

    function drawCards(count, labels = null, spreadName = null) {
      const question = document.getElementById("question").value.trim();
      const shuffled = shuffle(cards);
      const selected = shuffled.slice(0, count);
      lastSelectedCards = selected;

      // Build result string
      let header = `ğŸ´ æŠ½ç‰Œå•é¡Œï¼š${question || "ï¼ˆæœªè¼¸å…¥ï¼‰"}`;
      if (spreadName) {
        header += `\nç‰Œé™£ï¼š${spreadName}`;
      }
      header += '\n\n';
      const lines = selected.map((card, idx) => {
        if (labels) {
          return `${idx + 1}. ${labels[idx]}ï¼š${card}`;
        }
        return `${count === 1 ? '' : idx + 1 + '. '}${card}`;
      });
      lastResult = header + lines.join('\n');
      resultDiv.innerText = lastResult;

      imagesDiv.innerHTML = selected.map(card => {
        const fileName = encodeURIComponent(card);
        const imgPath = `images/thoth/${fileName}.jpg`;
        return `<img src="${imgPath}" alt="${card}" onerror="this.onerror=null;this.src='images/thoth/é è¨­.jpg';">`;
      }).join("");

      // Save to history
      let history = JSON.parse(localStorage.getItem("tarotHistory") || "[]");
      history.unshift(lastResult);
      if (history.length > 10) history.pop();
      localStorage.setItem("tarotHistory", JSON.stringify(history));
      renderHistory(history);
    }

    function renderHistory(history) {
      historyDiv.innerHTML = '<h3>ğŸ“œ æŠ½ç‰Œç´€éŒ„ï¼š</h3>' + history.map((r, i) => `
        <div class="history-entry">
          <pre>${r}</pre>
          <div class="history-entry-buttons">
            <button class="small-btn" aria-label="è¤‡è£½ç¬¬ ${i + 1} ç­†ç´€éŒ„" onclick="copyText(${i})">ğŸ“‹ è¤‡è£½</button>
            <button class="small-btn" aria-label="åˆªé™¤ç¬¬ ${i + 1} ç­†ç´€éŒ„" onclick="deleteEntry(${i})">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }

    function copyText(index) {
      const history = JSON.parse(localStorage.getItem("tarotHistory") || "[]");
      navigator.clipboard.writeText(history[index]);
    }

    function deleteEntry(index) {
      let history = JSON.parse(localStorage.getItem("tarotHistory") || "[]");
      history.splice(index, 1);
      localStorage.setItem("tarotHistory", JSON.stringify(history));
      renderHistory(history);
    }

    function copyResult() {
      navigator.clipboard.writeText(lastResult);
    }

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    // Share result as image
    function shareAsImage() {
      if (!lastResult) return;
      const width = 600;
      const height = 400;
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      // background color depends on theme
      const isLight = document.body.classList.contains('light-mode');
      ctx.fillStyle = isLight ? '#ffffff' : '#273649';
      ctx.fillRect(0, 0, width, height);
      ctx.fillStyle = isLight ? '#232f45' : '#e0e6ed';
      ctx.font = '18px Segoe UI';
      const lines = lastResult.split('\n');
      let y = 30;
      lines.forEach(line => {
        ctx.fillText(line, 20, y);
        y += 26;
      });
      // draw selected card images
      const promises = lastSelectedCards.map((card, idx) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.src = `images/thoth/${encodeURIComponent(card)}.jpg`;
          img.onload = () => resolve({img, idx});
          img.onerror = () => resolve(null);
        });
      });
      Promise.all(promises).then(results => {
        const cardCount = lastSelectedCards.length;
        const cardWidth = Math.min(100, (width - 40) / cardCount - 10);
        const yOffset = height - 150;
        results.forEach((res, i) => {
          if (res) {
            const xPos = 20 + i * (cardWidth + 10);
            ctx.drawImage(res.img, xPos, yOffset, cardWidth, 130);
          }
        });
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'tarot_result.png';
        link.click();
      });
    }

    // Prompt management
    function loadPrompts() {
      savedPrompts = JSON.parse(localStorage.getItem('tarotPrompts') || '[]');
      renderPrompts();
    }

    function savePrompt() {
      const input = document.getElementById('newPrompt');
      const q = input.value.trim();
      if (q) {
        savedPrompts.push(q);
        localStorage.setItem('tarotPrompts', JSON.stringify(savedPrompts));
        input.value = '';
        renderPrompts();
      }
    }

    function renderPrompts() {
      const list = savedPrompts.map((q, idx) => `<li><span onclick="setPrompt(${idx})">${q}</span> <button class="small-btn" onclick="deletePrompt(${idx})">åˆªé™¤</button></li>`).join('');
      document.getElementById('promptList').innerHTML = list;
    }

    function setPrompt(idx) {
      document.getElementById('question').value = savedPrompts[idx];
    }

    function deletePrompt(idx) {
      savedPrompts.splice(idx, 1);
      localStorage.setItem('tarotPrompts', JSON.stringify(savedPrompts));
      renderPrompts();
    }

    // Onload: restore history, prompts, theme, and update spread description
    window.onload = () => {
      const history = JSON.parse(localStorage.getItem('tarotHistory') || '[]');
      if (history.length > 0) renderHistory(history);
      // restore theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
      }
      // load prompts
      loadPrompts();
      // update description
      updateSpreadDescription();
    }
  </script>
</body>
</html>
